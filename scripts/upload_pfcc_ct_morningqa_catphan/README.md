# CT QA Report Import Script

This script automatically finds all `report.html` files under `cases` directories, extracts measurement values, and creates form submissions in the DocuForms system.

## Overview

The script parses CT QA case report HTML files generated by the CTQA application and imports them as form submissions. It extracts:

- Case information (date/time, operator)
- HU Consistency measurements (Air, PMP, Bone50, LDPE, Polystyrene, Acrylic, Bone20, Delrin, Teflon)
- Geometric Accuracy measurements (in-plane and out-of-plane)
- Uniformity measurements (HU and Integral)
- Low Contrast (STD) measurements
- High Contrast (RMTF) measurements

For each measurement, it extracts:
- **Value**: The measured value
- **Baseline**: The reference/baseline value
- **Error**: The difference (value - baseline), calculated automatically if not present

The script also calculates PASS/WARNING/FAIL results based on configurable error ranges and submits everything to the DocuForms backend API.

## Requirements

- Python 3.6 or higher
- Dependencies listed in `requirements.txt`

## Installation

1. Install Python dependencies:

```bash
pip install -r requirements.txt
```

## Usage

### Basic Usage

```bash
python import_reports_to_submissions.py <base_directory>
```

Example:

```bash
python import_reports_to_submissions.py _data/GECTSH
```

### Command Line Options

```bash
python import_reports_to_submissions.py [OPTIONS] <base_directory>

Arguments:
  base_directory          Base directory to search for cases/report.html files

Options:
  --form-id FORM_ID       Form ID to submit to (default: ctqa_catphan_604)
  --backend-url URL       Backend URL (default: http://localhost:8001)
  --dry-run               Parse files but do not submit (useful for testing)
```

### Examples

**Dry run (test without submitting):**

```bash
python import_reports_to_submissions.py _data/GECTSH --dry-run
```

**Submit to a different form:**

```bash
python import_reports_to_submissions.py _data/GECTSH --form-id my_form_id
```

**Submit to a different backend:**

```bash
python import_reports_to_submissions.py _data/GECTSH --backend-url http://example.com:8001
```

## Directory Structure

The script expects the following directory structure:

```
_data/
└── GECTSH/
    └── cases/
        └── YYYYMMDD_HHMMSS/
            └── 3.analysis/
                └── report.html
```

The script will recursively search for all `report.html` files under any `cases` directory.

## How It Works

1. **File Discovery**: Recursively searches for all `report.html` files under `cases` directories
2. **HTML Parsing**: Uses BeautifulSoup to parse the HTML and extract:
   - Case date/time and operator from input fields
   - Measurement values from tables (HU, Ref, Diff columns)
3. **Value Extraction**: Maps report.html table rows to form field IDs:
   - HU materials (Air, PMP, etc.) → `hu_air`, `hu_pmp`, etc.
   - Geometric measurements → `geo_in_pt1_pt2`, `geo_out_pt5_pt6`, etc.
   - Uniformity positions → `uniformity_hu_ctr`, `uniformity_hu_ant`, etc.
4. **Error Calculation**: Calculates error as `value - baseline` if not already present in the report
5. **Result Calculation**: Determines PASS/WARNING/FAIL for each error field based on configured ranges
6. **Metadata Building**: Creates metadata with:
   - Scripts for baseline autofill (`autofill_baseline`)
   - Scripts for error calculation (`calc_physical_error`)
   - Pass/warning ranges (`data-pass-range`, `data-warning-range`)
   - Result status (PASS/WARNING/FAIL)
7. **Overall Result**: Calculates form-level result:
   - **FAIL** if any field is FAIL
   - **WARNING** if any field is WARNING (and none are FAIL)
   - **PASS** if all fields are PASS
8. **API Submission**: Submits the complete submission to the DocuForms backend API

## Error Ranges

The script uses the following error ranges for PASS/WARNING/FAIL determination:

| Field Category | Pass Range | Warning Range |
|---------------|------------|---------------|
| HU Consistency | -40:40 | -60:60 |
| Geometric (In-plane) | -1:1 | -1.5:1.5 |
| Geometric (Out-of-plane) | -1.5:1.5 | -2:2 |
| Uniformity (HU) | -20:20 | -30:30 |
| Uniformity (Integral) | -0.05:0.05 | -0.1:0.1 |
| Low Contrast (STD) | 0:100 | 0:150 |
| High Contrast (RMTF) | 0.5:1 | 0.3:1 |
| High Contrast (RMTF=50%) | 0.4:1 | 0.2:1 |

## Output

The script prints progress information for each report file processed:

```
Processing: _data/GECTSH/cases/20251218_070010/3.analysis/report.html
  Case Date/Time: 20251218_070010
  Operator: JA
  Fields extracted: 25
  Overall Result: PASS
✓ Submitted: 20251218_070010
```

At the end, it shows a summary:

```
============================================================
Summary: 5 succeeded, 0 failed
```

## Form HTML

The form template (`ct_qa_case_form_card.html`) defines the structure of the CT QA Case Review Form. This form should be uploaded to the Form Builder before running the import script.

## Troubleshooting

**No report.html files found:**
- Ensure the base directory path is correct
- Check that the directory structure includes `cases` folders
- Verify that `report.html` files exist in `3.analysis` subdirectories

**Submission errors:**
- Verify the backend URL is correct and the server is running
- Check that the form ID exists in the database
- Use `--dry-run` to test parsing without submitting

**Missing values:**
- The script will calculate errors automatically if baseline and value are present
- Some fields may be missing if the report.html structure differs from expected format
- Check the console output for warnings about missing data

## Notes

- The script automatically calculates error values (value - baseline) if they're not present in the report
- Case date/time is extracted from the report HTML or inferred from the directory path
- The script handles multiple RMTF values and selects the one closest to 0.5 for RMTF=50%
- All numeric values are converted to strings for consistency with the form submission format
